<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat WebSocket</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="window">
        <div class="window-title">üí¨ Chat WebSocket - Windows 98 Style</div>
        <div class="window-content">
            <h1>Chat WebSocket</h1>

            <div id="status">Connexion en cours...</div>

            <div id="messages"></div>

            <div class="input-container">
                <input type="text" id="messageInput" placeholder="Tapez votre message ici..." />
                <button id="sendButton">Envoyer</button>
                <button id="timestampToggle">D√©sactiver horodatage</button>
            </div>
        </div>
    </div>

    <script>
        // Connexion au serveur WebSocket
        const ws = new WebSocket('ws://localhost:8080');

        // √âl√©ments du DOM
        const statusDiv = document.getElementById('status');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const timestampToggle = document.getElementById('timestampToggle');

        // Variables de configuration
        let lastSentMessage = null;
        let showTimestamps = true;

        // Gestionnaire d'√©v√©nement pour la connexion √©tablie
        ws.onopen = function(event) {
            console.log('Connexion WebSocket √©tablie');
            statusDiv.textContent = 'Connect√© au serveur';
            statusDiv.style.backgroundColor = '#d4edda';
        };

        // Gestionnaire d'√©v√©nement pour les messages re√ßus
        ws.onmessage = function(event) {
            console.log('Message re√ßu:', event.data);

            // Extraire le message sans le timestamp pour la comparaison
            const messageContent = event.data.replace(/^\[[^\]]+\]\s*/, '');
            
            const messageDiv = document.createElement('div');
            
            // V√©rifier si c'est notre propre message
            if (lastSentMessage && messageContent === lastSentMessage) {
                // C'est notre message, afficher avec le style sp√©cial
                messageDiv.className = 'message own-message';
                lastSentMessage = null; // R√©initialiser apr√®s utilisation
            } else {
                // Message d'un autre utilisateur, style normal
                messageDiv.className = 'message';
            }
            
            // Stocker le texte complet pour la fonction de bascule
            messageDiv.dataset.fullText = event.data;
            
            // Afficher le message avec ou sans horodatage selon la pr√©f√©rence
            const displayText = showTimestamps ? event.data : messageContent;
            messageDiv.textContent = displayText;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        };

        // Gestionnaire d'√©v√©nement pour les erreurs
        ws.onerror = function(error) {
            console.error('Erreur WebSocket:', error);
            statusDiv.textContent = 'Erreur de connexion';
            statusDiv.style.backgroundColor = '#f8d7da';
        };

        // Gestionnaire d'√©v√©nement pour la fermeture de connexion
        ws.onclose = function(event) {
            console.log('Connexion WebSocket ferm√©e');
            statusDiv.textContent = 'D√©connect√© du serveur';
            statusDiv.style.backgroundColor = '#f8d7da';
        };

        // Fonction pour envoyer un message
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && ws.readyState === WebSocket.OPEN) {
                // Stocker le message pour pouvoir l'identifier quand il reviendra du serveur
                lastSentMessage = message;
                
                // Envoyer le message via WebSocket
                ws.send(message);
                messageInput.value = '';
                messageInput.focus();
            }
        }

        // Fonction pour basculer l'affichage des horodatages
        function toggleTimestamps() {
            showTimestamps = !showTimestamps;
            timestampToggle.textContent = showTimestamps ? 'D√©sactiver horodatage' : 'Activer horodatage';
            
            // Mettre √† jour tous les messages existants
            const existingMessages = messagesDiv.querySelectorAll('.message');
            existingMessages.forEach(messageDiv => {
                const fullText = messageDiv.dataset.fullText || messageDiv.textContent;
                const messageContent = fullText.replace(/^\[[^\]]+\]\s*/, '');
                
                // Stocker le texte complet si ce n'est pas d√©j√† fait
                if (!messageDiv.dataset.fullText) {
                    messageDiv.dataset.fullText = fullText;
                }
                
                // Afficher avec ou sans horodatage
                messageDiv.textContent = showTimestamps ? fullText : messageContent;
            });
        }

        // Gestionnaire d'√©v√©nement pour le bouton d'envoi
        sendButton.addEventListener('click', sendMessage);

        // Gestionnaire d'√©v√©nement pour le bouton de bascule d'horodatage
        timestampToggle.addEventListener('click', toggleTimestamps);

        // Gestionnaire d'√©v√©nement pour la touche Entr√©e dans le champ de saisie
        messageInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
